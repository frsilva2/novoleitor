<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de controle de estoque com scanner mobile real">
    <title>Sistema de Estoque - Scanner Real</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    
    <!-- CSS Inline (para simplicidade) -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }

        .header h1 { font-size: 1.8em; margin-bottom: 5px; font-weight: 300; }
        .header p { opacity: 0.9; font-size: 0.9em; }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover { background: rgba(52, 152, 219, 0.1); color: #3498db; }
        .tab.active { background: #3498db; color: white; }

        .content { padding: 15px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .input-group { margin-bottom: 15px; }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .camera-container {
            position: relative;
            background: #2c3e50;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            height: 300px;
        }

        #scanner-container { 
            width: 100%; 
            height: 100%; 
            position: relative;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #27ae60;
            width: 80%;
            height: 80px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.5);
            z-index: 10;
        }

        .scanner-status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
            z-index: 11;
        }

        .btn-mobile {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 120px;
            touch-action: manipulation;
            margin: 5px;
        }

        .btn-mobile:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success { background: linear-gradient(135deg, #27ae60, #219a52); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 { font-size: 2em; margin-bottom: 10px; }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 0.85em;
        }

        .result-table th, .result-table td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .result-table th {
            background: #3498db;
            color: white;
            font-weight: 500;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 10px;
            right: 10px;
            padding: 15px;
            border-radius: 10px;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
            z-index: 2000;
            text-align: center;
            font-weight: 500;
        }

        .notification.show { transform: translateY(0); }
        .notification.success { background: #27ae60; color: white; }
        .notification.error { background: #e74c3c; color: white; }
        .notification.warning { background: #f39c12; color: white; }

        @media (max-width: 768px) {
            .container { border-radius: 0; min-height: 100vh; }
            body { padding: 0; }
            .camera-container { height: 250px; }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Scanner Real - Sistema de Estoque</h1>
            <p>Decodifica√ß√£o autom√°tica de c√≥digos EUROTEXTIL e LITORAL</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showSection('scanner')">Scanner</button>
            <button class="tab" onclick="showSection('inventory')">Invent√°rio</button>
            <button class="tab" onclick="showSection('export')">Exportar</button>
            <button class="tab" onclick="showSection('biblioteca')">Biblioteca</button>
        </div>

        <div class="content">
            <!-- Scanner Section -->
            <div id="scanner" class="section active">
                <div class="card">
                    <h2>Scanner Mobile Real</h2>
                    <div class="camera-container">
                        <div id="scanner-container"></div>
                        <div class="scanner-overlay"></div>
                        <div class="scanner-status" id="scannerStatus">Clique em "Iniciar Scanner" para come√ßar</div>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button class="btn-mobile" id="startBtn">Iniciar Scanner</button>
                        <button class="btn-mobile" id="stopBtn" disabled>Parar Scanner</button>
                        <button class="btn-mobile" id="flashBtn" style="display:none;">Flash</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Dados Decodificados</h3>
                    <div class="input-group">
                        <label>C√≥digo do Fornecedor:</label>
                        <input type="text" id="barcode" readonly placeholder="Aguardando leitura...">
                    </div>
                    
                    <div class="input-group">
                        <label>Produto Identificado:</label>
                        <input type="text" id="productName" readonly placeholder="Ser√° identificado automaticamente">
                    </div>
                    
                    <div class="input-group">
                        <label>C√≥digo ERP:</label>
                        <input type="text" id="erpCodeDisplay" readonly placeholder="Convertido automaticamente">
                    </div>
                    
                    <div class="input-group">
                        <label>Quantidade (MT):</label>
                        <input type="number" id="quantity" step="0.1" placeholder="Auto-preenchida">
                    </div>
                    
                    <div class="input-group">
                        <label>Cor:</label>
                        <input type="text" id="color" placeholder="Auto-detectada">
                    </div>

                    <div class="input-group">
                        <label>Observa√ß√µes:</label>
                        <input type="text" id="observations" placeholder="Informa√ß√µes adicionais">
                    </div>

                    <button class="btn-mobile btn-success" onclick="adicionarItem()" style="width: 100%; margin-top: 10px;">
                        Confirmar e Registrar
                    </button>
                    
                    <p style="margin-top: 10px; text-align: center; color: #666;">
                        Total registrado: <span id="collectedCount">0</span> itens
                    </p>
                </div>

                <!-- Manual Input -->
                <div class="card">
                    <h3>Entrada Manual</h3>
                    <div class="input-group">
                        <label>Digite o c√≥digo completo:</label>
                        <input type="text" id="manualBarcode" placeholder="Ex: 0000004700103.000050000.000SDE999.230132.02377">
                    </div>
                    <button class="btn-mobile" onclick="processarCodigoManual()">Processar C√≥digo</button>
                </div>
            </div>

            <!-- Inventory Section -->
            <div id="inventory" class="section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalItems">0</h3>
                        <p>Itens Coletados</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalMeters">0</h3>
                        <p>Total Metros</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalValue">R$ 0</h3>
                        <p>Estimativa</p>
                    </div>
                </div>

                <div class="card">
                    <h2>Invent√°rio Coletado</h2>
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>C√≥digo ERP</th>
                                <th>Nome ERP</th>
                                <th>Qtd (MT)</th>
                                <th>Cor</th>
                                <th>Data</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Export Section -->
            <div id="export" class="section">
                <div class="card">
                    <h2>Exportar Dados</h2>
                    <p>Total coletado: <strong id="exportCount">0</strong> itens</p>
                    
                    <button class="btn-mobile btn-success" onclick="exportarExcel()" style="width: 100%; margin: 20px 0;">
                        Exportar para Excel
                    </button>
                    
                    <button class="btn-mobile btn-danger" onclick="limparDados()" style="width: 100%;">
                        Limpar Todos os Dados
                    </button>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                        <h4>Formato de Sa√≠da:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>C√≥digo ERP</strong> - Seu c√≥digo interno</li>
                            <li><strong>Nome ERP</strong> - Nome do produto no seu sistema</li>
                            <li><strong>Quantidade</strong> - Em metros (MT)</li>
                            <li><strong>Cor</strong> - Decodificada automaticamente</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Biblioteca Section -->
            <div id="biblioteca" class="section">
                <div class="card">
                    <h2>Biblioteca DE‚ÜíPARA</h2>
                    <div id="bibliotecaStatus" style="background: #27ae60; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div class="loading" style="display: none;"></div>
                        <h3>Carregando biblioteca...</h3>
                        <p>Produtos na biblioteca: <span id="totalMappings">0</span></p>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; border-left: 4px solid #27ae60;">
                        <h4>Como funciona:</h4>
                        <p style="margin: 5px 0;">üîç Scanner l√™ c√≥digo ‚Üí Identifica padr√£o automaticamente</p>
                        <p style="margin: 5px 0;">üìö Busca na biblioteca ‚Üí Converte para c√≥digo ERP</p>
                        <p style="margin: 5px 0;">üéØ Decodifica dados ‚Üí Extrai quantidade e cor</p>
                        <p style="margin: 5px 0;">üìä Exporta planilha ‚Üí Formato pronto para ERP</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Scripts Modulares -->
    <script src="./js/decoder.js"></script>
    <script src="./js/scanner.js"></script>
    
    <!-- Script Principal -->
    <script>
        // Estado global da aplica√ß√£o
        let inventario = [];
        let bibliotecaDePara = {};

        // Carregar biblioteca DE->PARA do JSON
        async function carregarBiblioteca() {
    try {
      console.log('=== INICIANDO CARREGAMENTO DA BIBLIOTECA ===');
      const url = `./data/depara.json?v=${Date.now()}`; // cache-bust
      console.log('Tentando carregar:', url);

      const response = await fetch(url, { cache: 'no-store' });
      console.log('Status da resposta:', response.status, response.statusText);
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

      const texto = await response.text();
      console.log('Tamanho do arquivo:', texto.length, 'caracteres');
      console.log('Primeiros 200 caracteres:', texto.substring(0, 200));

      const dados = JSON.parse(texto);
      console.log('JSON parseado com sucesso');
      console.log('Tipo de dados:', Array.isArray(dados) ? 'Array' : 'Object');

      // === NOVO: aceita OBJETO {produtos:{...}} ou ARRAY de linhas ===
      bibliotecaDePara = {};
      let erros = 0;

      if (dados && typeof dados === 'object' && !Array.isArray(dados)) {
        // Formato MAPA: { produtos: { "20030005": {codigoERP, nomeERP, fornecedor}, ... }, mapeamentoCores: {...} }
        if (!dados.produtos || typeof dados.produtos !== 'object') {
          throw new Error('Formato inv√°lido: objeto sem chave "produtos"');
        }
        bibliotecaDePara = dados.produtos;
        console.log('Biblioteca (mapa) carregada:', Object.keys(bibliotecaDePara).length, 'produtos');
      } else if (Array.isArray(dados)) {
        // Formato ARRAY: converte para mapa por codigoprodutofornecedor
        dados.forEach((item, index) => {
          const cod = (item?.codigoprodutofornecedor ?? '').toString().replace(/\D+/g,'').replace(/^0+/, '');
          if (!cod) { erros++; console.warn(`Registro ${index} sem c√≥digo:`, item); return; }

          bibliotecaDePara[cod] = {
            codigoERP: item.codigoerp != null ? String(item.codigoerp).split('.')[0] : null,
            nomeERP: item.nomeerp ?? null,
            fornecedor: (item.fornecedor_grupo ?? '').toString().trim().toUpperCase(),
            produtoFornecedor: item.produtofornecedor ?? null,
            ncm: item.ncm ?? null,
            unidade: item.unidademedida ?? null
          };
        });
        console.log('Biblioteca (array‚Üímapa) processada:', Object.keys(bibliotecaDePara).length, 'produtos', '| ignorados:', erros);
      } else {
        throw new Error('Formato inv√°lido: tipo ' + typeof dados);
      }

      const totalCarregado = Object.keys(bibliotecaDePara).length;
      document.getElementById('totalMappings').textContent = totalCarregado;

      // Atualiza status visual
      const statusDiv = document.getElementById('bibliotecaStatus');
      if (statusDiv) {
        statusDiv.innerHTML = `
          <div style="background:#27ae60;color:#fff;padding:15px;border-radius:10px;margin-bottom:20px;">
            <h3>‚úÖ Biblioteca Carregada</h3>
            <p style="margin:5px 0;">Produtos: ${totalCarregado}</p>
            <p style="margin:5px 0;font-size:.9em;">Arquivo: data/depara.json</p>
          </div>
        `;
      }

      // Logs de verifica√ß√£o
      console.log('=== TESTANDO C√ìDIGOS CONHECIDOS ===');
      ['4700103', '20000', '20030005', '1468100', '5038103'].forEach(c => {
        const ok = bibliotecaDePara[c] ? '‚úÖ' : '‚ùå';
        console.log(`${ok} ${c}:`, bibliotecaDePara[c]?.nomeERP || 'n√£o encontrado');
      });

      return totalCarregado;

    } catch (error) {
      console.error('=== ERRO NO CARREGAMENTO ===');
      console.error('Tipo:', error.name);
      console.error('Mensagem:', error.message);
      console.error('Stack:', error.stack);

      showNotification('Erro ao carregar biblioteca: ' + error.message, 'error');

      // Fallback m√≠nimo (mantido)
      console.warn('Usando biblioteca FALLBACK (5 produtos)');
      bibliotecaDePara = {
        "5038103": { codigoERP: "14527", nomeERP: "ALFAIATARIA NEW LOOK - LISO", fornecedor: "EURO" },
        "4700103": { codigoERP: "9109", nomeERP: "OXFORDINE", fornecedor: "EURO" },
        "20000":   { codigoERP: "14527", nomeERP: "ALFAIATARIA NEW LOOK - LISO", fornecedor: "LITORAL" },
        "1468100": { codigoERP: "9532",  nomeERP: "PERCAL - 400 FIOS", fornecedor: "EURO" },
        "732100":  { codigoERP: "12779", nomeERP: "VOIL 100% POLIESTER", fornecedor: "EURO" }
      };
      document.getElementById('totalMappings').textContent = Object.keys(bibliotecaDePara).length;

      const statusDiv = document.getElementById('bibliotecaStatus');
      if (statusDiv) {
        statusDiv.innerHTML = `
          <div style="background:#e74c3c;color:#fff;padding:15px;border-radius:10px;margin-bottom:20px;">
            <h3>‚ö†Ô∏è Erro no Carregamento</h3>
            <p style="margin:5px 0;">Usando fallback: 5 produtos</p>
            <p style="margin:5px 0;font-size:.9em;">Erro: ${error.message}</p>
          </div>
        `;
      }

      return Object.keys(bibliotecaDePara).length;
    }
  }
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Carregar biblioteca primeiro
                const totalProdutos = await carregarBiblioteca();
                
                // Inicializar scanner com a biblioteca carregada
                if (window.ScannerReal) {
                    window.ScannerReal.bibliotecaDePara = bibliotecaDePara;
                    await window.ScannerReal.init();
                }
                
                // Configurar event listeners
                setupEventListeners();
                
                // Atualizar displays
                atualizarDisplays();
                
                // Fun√ß√£o de teste dispon√≠vel no console
                window.testarCodigo = function(codigo) {
                    console.log('=== TESTE DE C√ìDIGO ===');
                    console.log('C√≥digo:', codigo);
                    console.log('Biblioteca carregada?', Object.keys(bibliotecaDePara).length > 0);
                    console.log('C√≥digo existe na biblioteca?', bibliotecaDePara[codigo] ? 'SIM' : 'N√ÉO');
                    
                    if (window.CodigoDecoder) {
                        const resultado = window.CodigoDecoder.decodificar(codigo, bibliotecaDePara);
                        console.log('Resultado decoder:', resultado);
                        return resultado;
                    } else {
                        console.log('CodigoDecoder n√£o carregado');
                    }
                };
                
                showNotification(`Sistema iniciado! ${totalProdutos} produtos carregados.`, 'success');
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showNotification('Erro ao inicializar sistema: ' + error.message, 'error');
            }
        });

        function setupEventListeners() {
            // Event listeners para entrada manual
            document.getElementById('manualBarcode')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processarCodigoManual();
                }
            });
        }

        function processarCodigoManual() {
            const codigo = document.getElementById('manualBarcode').value.trim();
            if (!codigo) {
                showNotification('Digite um c√≥digo v√°lido', 'error');
                return;
            }
            
            // Processar usando o decoder com a biblioteca carregada
            const resultado = window.CodigoDecoder.decodificar(codigo, bibliotecaDePara);
            
            if (resultado && resultado.nomeERP !== 'PRODUTO N√ÉO MAPEADO') {
                preencherCampos(resultado);
                showNotification(`Produto encontrado: ${resultado.nomeERP}`, 'success');
            } else {
                preencherCamposDesconhecido(codigo);
                showNotification('C√≥digo n√£o encontrado na biblioteca', 'warning');
            }
            
            document.getElementById('manualBarcode').value = '';
        }

        // Preencher campos quando produto √© encontrado
        function preencherCampos(resultado) {
            document.getElementById('barcode').value = resultado.codigoFornecedor || '';
            document.getElementById('productName').value = resultado.nomeERP || '';
            document.getElementById('erpCodeDisplay').value = resultado.codigoERP || '';
            
            if (resultado.quantidade > 0) {
                document.getElementById('quantity').value = resultado.quantidade;
            }
            
            if (resultado.cor) {
                document.getElementById('color').value = resultado.cor;
            }
            
            if (resultado.observacoes) {
                document.getElementById('observations').value = resultado.observacoes;
            }
        }

        // Preencher para c√≥digo desconhecido
        function preencherCamposDesconhecido(codigo) {
            document.getElementById('barcode').value = codigo;
            document.getElementById('productName').value = 'PRODUTO N√ÉO MAPEADO';
            document.getElementById('erpCodeDisplay').value = codigo;
            document.getElementById('quantity').value = '';
            document.getElementById('color').value = '';
            document.getElementById('observations').value = 'Produto n√£o encontrado na biblioteca';
        }

        function adicionarItem() {
            const codigoFornecedor = document.getElementById('barcode').value;
            const nomeERP = document.getElementById('productName').value;
            const codigoERP = document.getElementById('erpCodeDisplay').value;
            const quantidade = parseFloat(document.getElementById('quantity').value);
            const cor = document.getElementById('color').value;
            const observacoes = document.getElementById('observations').value;
            
            if (!codigoFornecedor || !quantidade || quantidade <= 0) {
                showNotification('Preencha c√≥digo e quantidade v√°lida', 'error');
                return;
            }
            
            const item = {
                id: Date.now(),
                codigoFornecedor,
                codigoERP,
                nomeERP,
                quantidade,
                cor: cor || 'N/A',
                observacoes: observacoes || '',
                data: new Date().toLocaleDateString('pt-BR'),
                timestamp: new Date().toISOString()
            };
            
            inventario.push(item);
            limparFormulario();
            atualizarDisplays();
            salvarInventario();
            
            showNotification(`Item ${inventario.length} registrado com sucesso!`, 'success');
        }

        function limparFormulario() {
            ['barcode', 'productName', 'erpCodeDisplay', 'quantity', 'color', 'observations'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function atualizarDisplays() {
            // Atualizar contadores
            const totalItens = inventario.length;
            const totalMetros = inventario.reduce((sum, item) => sum + item.quantidade, 0);
            const valorEstimado = totalMetros * 15; // R$ 15 por metro estimado
            
            document.getElementById('collectedCount').textContent = totalItens;
            document.getElementById('exportCount').textContent = totalItens;
            document.getElementById('totalItems').textContent = totalItens;
            document.getElementById('totalMeters').textContent = totalMetros.toFixed(1);
            document.getElementById('totalValue').textContent = 'R$ ' + valorEstimado.toLocaleString('pt-BR');
            
            // Atualizar tabela de invent√°rio
            atualizarTabelaInventario();
        }

        function atualizarTabelaInventario() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            inventario.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.codigoERP}</td>
                    <td style="font-size: 0.8em;">${item.nomeERP}</td>
                    <td>${item.quantidade.toFixed(1)}</td>
                    <td>${item.cor}</td>
                    <td style="font-size: 0.8em;">${item.data}</td>
                    <td>
                        <button onclick="removerItem(${item.id})" 
                                style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7em;">
                            Remover
                        </button>
                    </td>
                `;
            });
        }

        function removerItem(id) {
            inventario = inventario.filter(item => item.id !== id);
            atualizarDisplays();
            salvarInventario();
            showNotification('Item removido', 'success');
        }

        function exportarExcel() {
            if (inventario.length === 0) {
                showNotification('Nenhum item para exportar', 'warning');
                return;
            }

            const dadosExport = inventario.map((item, index) => ({
                'Item': index + 1,
                'C√≥digo ERP': item.codigoERP,
                'Nome ERP': item.nomeERP,
                'Quantidade': item.quantidade,
                'Unidade': 'MT',
                'Cor': item.cor,
                'C√≥digo Fornecedor': item.codigoFornecedor,
                'Observa√ß√µes': item.observacoes,
                'Data Coleta': item.data
            }));

            const ws = XLSX.utils.json_to_sheet(dadosExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inventario');

            // Ajustar largura das colunas
            ws['!cols'] = [
                {width: 8}, {width: 15}, {width: 30}, {width: 12},
                {width: 8}, {width: 12}, {width: 15}, {width: 25}, {width: 12}
            ];

            const filename = `inventario_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification(`Exportado: ${inventario.length} itens`, 'success');
        }

        function limparDados() {
            if (confirm('Limpar todos os dados coletados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                inventario = [];
                atualizarDisplays();
                salvarInventario();
                showNotification('Todos os dados foram limpos', 'success');
            }
        }

        function salvarInventario() {
            try {
                localStorage.setItem('inventario_textil', JSON.stringify(inventario));
            } catch (e) {
                console.error('Erro ao salvar invent√°rio:', e);
            }
        }

        function carregarInventario() {
            try {
                const saved = localStorage.getItem('inventario_textil');
                if (saved) {
                    inventario = JSON.parse(saved);
                    atualizarDisplays();
                }
            } catch (e) {
                console.error('Erro ao carregar invent√°rio:', e);
            }
        }

        function showSection(sectionId) {
            // Remover active de todas as se√ß√µes e tabs
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Ativar se√ß√£o e tab selecionadas
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            // Atualizar displays se necess√°rio
            if (sectionId === 'inventory') {
                atualizarDisplays();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Carregar invent√°rio ao inicializar
        carregarInventario();
    </script>
</body>
</html>
