<!-- Script Principal (revisado) -->
<script>
  // ===== Estado global do inventário =====
  let inventario = [];

  // Inicialização: somente o ScannerReal faz o carregamento da biblioteca
  window.addEventListener('DOMContentLoaded', () => {
    if (window.ScannerReal && typeof window.ScannerReal.init === 'function') {
      window.ScannerReal.init();
    }
    carregarInventario();
    atualizarDisplays();
    // Atalho: Enter na entrada manual
    document.getElementById('manualBarcode')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') processarCodigoManual();
    });
  });

  // ===== Entrada manual utilizando o decoder do Scanner =====
  function processarCodigoManual() {
    const codigo = document.getElementById('manualBarcode').value.trim();
    if (!codigo) {
      showNotification('Digite um código válido', 'error');
      return;
    }
    if (!window.ScannerReal || typeof window.ScannerReal.processarCodigo !== 'function') {
      showNotification('Scanner não inicializado', 'error');
      return;
    }
    // Usa o fluxo oficial do scanner (preenche os campos via decoder.js)
    window.ScannerReal.processarCodigo(codigo);
    document.getElementById('manualBarcode').value = '';
  }

  // ===== Inventário =====
  function adicionarItem() {
    const codigoFornecedor = document.getElementById('barcode').value;
    const nomeERP         = document.getElementById('productName').value;
    const codigoERP       = document.getElementById('erpCodeDisplay').value;
    const quantidade      = parseFloat(document.getElementById('quantity').value);
    const cor             = document.getElementById('color').value;
    const observacoes     = document.getElementById('observations').value;

    if (!codigoFornecedor || !quantidade || quantidade <= 0) {
      showNotification('Preencha código e quantidade válida', 'error');
      return;
    }

    const item = {
      id: Date.now(),
      codigoFornecedor,
      codigoERP,
      nomeERP,
      quantidade,
      cor: cor || 'N/A',
      observacoes: observacoes || '',
      data: new Date().toLocaleDateString('pt-BR'),
      timestamp: new Date().toISOString()
    };

    inventario.push(item);
    limparFormulario();
    atualizarDisplays();
    salvarInventario();
    showNotification(`Item ${inventario.length} registrado com sucesso!`, 'success');
  }

  function limparFormulario() {
    ['barcode','productName','erpCodeDisplay','quantity','color','observations']
      .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
  }

  function atualizarDisplays() {
    const totalItens  = inventario.length;
    const totalMetros = inventario.reduce((sum, item) => sum + (item.quantidade || 0), 0);
    const valorEstimado = totalMetros * 15; // estimativa simples

    setText('collectedCount', totalItens);
    setText('exportCount',   totalItens);
    setText('totalItems',    totalItens);
    setText('totalMeters',   totalMetros.toFixed(1));
    setText('totalValue',    'R$ ' + valorEstimado.toLocaleString('pt-BR'));

    atualizarTabelaInventario();
  }

  function atualizarTabelaInventario() {
    const tbody = document.getElementById('inventoryBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    inventario.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.codigoERP || ''}</td>
        <td style="font-size: 0.8em;">${item.nomeERP || ''}</td>
        <td>${(item.quantidade ?? 0).toFixed(1)}</td>
        <td>${item.cor || ''}</td>
        <td style="font-size: 0.8em;">${item.data || ''}</td>
        <td>
          <button onclick="removerItem(${item.id})"
            style="background:#e74c3c;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:0.7em;">
            Remover
          </button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function removerItem(id) {
    inventario = inventario.filter(i => i.id !== id);
    atualizarDisplays();
    salvarInventario();
    showNotification('Item removido', 'success');
  }

  function exportarExcel() {
    if (inventario.length === 0) {
      showNotification('Nenhum item para exportar', 'warning');
      return;
    }
    const dadosExport = inventario.map((item, idx) => ({
      'Item': idx + 1,
      'Código ERP': item.codigoERP,
      'Nome ERP': item.nomeERP,
      'Quantidade': item.quantidade,
      'Unidade': 'MT',
      'Cor': item.cor,
      'Código Fornecedor': item.codigoFornecedor,
      'Observações': item.observacoes,
      'Data Coleta': item.data
    }));
    const ws = XLSX.utils.json_to_sheet(dadosExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
    ws['!cols'] = [
      {width: 8},{width: 15},{width: 30},{width: 12},
      {width: 8},{width: 12},{width: 15},{width: 25},{width: 12}
    ];
    const filename = `inventario_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, filename);
    showNotification(`Exportado: ${inventario.length} itens`, 'success');
  }

  function limparDados() {
    if (confirm('Limpar todos os dados coletados? Esta ação não pode ser desfeita.')) {
      inventario = [];
      atualizarDisplays();
      salvarInventario();
      showNotification('Todos os dados foram limpos', 'success');
    }
  }

  function salvarInventario() {
    try { localStorage.setItem('inventario_textil', JSON.stringify(inventario)); }
    catch(e) { console.error('Erro ao salvar inventário:', e); }
  }
  function carregarInventario() {
    try {
      const saved = localStorage.getItem('inventario_textil');
      if (saved) inventario = JSON.parse(saved);
    } catch(e) { console.error('Erro ao carregar inventário:', e); }
  }

  // ===== Navegação de abas =====
  function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId)?.classList.add('active');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    // Mantém comportamento existente que usa event.target
    if (window.event && window.event.target && window.event.target.classList) {
      window.event.target.classList.add('active');
    }
    if (sectionId === 'inventory') atualizarDisplays();
  }

  // ===== Util =====
  function setText(id, txt) { const el = document.getElementById(id); if (el) el.textContent = txt; }
  function showNotification(message, type = 'success') {
    const el = document.getElementById('notification'); if (!el) return;
    el.textContent = message; el.className = `notification ${type} show`;
    setTimeout(() => el.classList.remove('show'), 3000);
  }

  // Expor funções usadas por botões no HTML
  window.processarCodigoManual = processarCodigoManual;
  window.adicionarItem = adicionarItem;
  window.exportarExcel = exportarExcel;
  window.limparDados = limparDados;
  window.removerItem = removerItem;
  window.showSection = showSection;
</script>
